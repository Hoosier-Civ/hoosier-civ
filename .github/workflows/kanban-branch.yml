name: Kanban — Branch → In Progress

on:
  push:
    branches:
      - 'feat/issue-*'
      - 'fix/issue-*'

jobs:
  move-to-in-progress:
    name: Move linked issue to In Progress
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Extract issue number from branch
        id: extract
        run: |
          BRANCH="${{ github.ref_name }}"
          ISSUE_NUMBER=$(echo "$BRANCH" | grep -oE 'issue-[0-9]+' | grep -oE '[0-9]+')
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "No issue number found in branch name — skipping"
            exit 0
          fi
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Auto-assign issue to pusher
        if: steps.extract.outputs.issue_number != ''
        run: |
          gh issue edit ${{ steps.extract.outputs.issue_number }} \
            --repo ${{ github.repository }} \
            --add-assignee ${{ github.actor }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Move issue to In Progress on project board
        if: steps.extract.outputs.issue_number != ''
        run: |
          ISSUE_NUMBER=${{ steps.extract.outputs.issue_number }}
          REPO=${{ github.repository }}
          PROJECT_NUMBER=1
          ORG=$(echo "$REPO" | cut -d/ -f1)
          IN_PROGRESS_OPTION_ID="34a05921"

          # Get the project item ID for this issue
          ITEM_ID=$(gh api graphql -f query="
            query {
              organization(login: \"$ORG\") {
                projectV2(number: $PROJECT_NUMBER) {
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue { number }
                      }
                    }
                  }
                }
              }
            }" --jq ".data.organization.projectV2.items.nodes[] | select(.content.number == $ISSUE_NUMBER) | .id")

          if [ -z "$ITEM_ID" ]; then
            echo "Issue #$ISSUE_NUMBER not found in project — skipping"
            exit 0
          fi

          # Get the Status field ID
          FIELD_ID=$(gh api graphql -f query="
            query {
              organization(login: \"$ORG\") {
                projectV2(number: $PROJECT_NUMBER) {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField { id name }
                    }
                  }
                }
              }
            }" --jq '.data.organization.projectV2.fields.nodes[] | select(.name == "Status") | .id')

          # Update the item status
          gh api graphql -f query="
            mutation {
              updateProjectV2ItemFieldValue(input: {
                projectId: \"PVT_kwDODryfUM4BP3nZ\"
                itemId: \"$ITEM_ID\"
                fieldId: \"$FIELD_ID\"
                value: { singleSelectOptionId: \"$IN_PROGRESS_OPTION_ID\" }
              }) {
                projectV2Item { id }
              }
            }"

          echo "Moved issue #$ISSUE_NUMBER to In Progress"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Move parent feature issue to In Progress
        if: steps.extract.outputs.issue_number != ''
        run: |
          ISSUE_NUMBER=${{ steps.extract.outputs.issue_number }}
          REPO=${{ github.repository }}
          ORG=$(echo "$REPO" | cut -d/ -f1)
          PROJECT_NUMBER=1
          IN_PROGRESS_OPTION_ID="34a05921"

          # Find the parent issue via GraphQL
          PARENT_NUMBER=$(gh api graphql -f query="
            query {
              repository(owner: \"$ORG\", name: \"$(echo $REPO | cut -d/ -f2)\") {
                issue(number: $ISSUE_NUMBER) {
                  parent { number }
                }
              }
            }" --jq '.data.repository.issue.parent.number // empty')

          if [ -z "$PARENT_NUMBER" ]; then
            echo "Issue #$ISSUE_NUMBER has no parent — skipping feature move"
            exit 0
          fi

          echo "Parent feature issue: #$PARENT_NUMBER"

          # Get the parent's project item ID
          PARENT_ITEM_ID=$(gh api graphql -f query="
            query {
              organization(login: \"$ORG\") {
                projectV2(number: $PROJECT_NUMBER) {
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue { number }
                      }
                    }
                  }
                }
              }
            }" --jq ".data.organization.projectV2.items.nodes[] | select(.content.number == $PARENT_NUMBER) | .id")

          if [ -z "$PARENT_ITEM_ID" ]; then
            echo "Parent issue #$PARENT_NUMBER not found in project — skipping"
            exit 0
          fi

          # Get the Status field ID
          FIELD_ID=$(gh api graphql -f query="
            query {
              organization(login: \"$ORG\") {
                projectV2(number: $PROJECT_NUMBER) {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField { id name }
                    }
                  }
                }
              }
            }" --jq '.data.organization.projectV2.fields.nodes[] | select(.name == "Status") | .id')

          # Move parent to In Progress only if it is currently in Todo
          CURRENT_STATUS=$(gh api graphql -f query="
            query {
              organization(login: \"$ORG\") {
                projectV2(number: $PROJECT_NUMBER) {
                  items(first: 100) {
                    nodes {
                      id
                      fieldValues(first: 10) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            name
                            field { ... on ProjectV2SingleSelectField { name } }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }" --jq ".data.organization.projectV2.items.nodes[] | select(.id == \"$PARENT_ITEM_ID\") | .fieldValues.nodes[] | select(.field.name == \"Status\") | .name // empty")

          if [ "$CURRENT_STATUS" = "Done" ] || [ "$CURRENT_STATUS" = "In Progress" ]; then
            echo "Parent #$PARENT_NUMBER is already '$CURRENT_STATUS' — skipping"
            exit 0
          fi

          gh api graphql -f query="
            mutation {
              updateProjectV2ItemFieldValue(input: {
                projectId: \"PVT_kwDODryfUM4BP3nZ\"
                itemId: \"$PARENT_ITEM_ID\"
                fieldId: \"$FIELD_ID\"
                value: { singleSelectOptionId: \"$IN_PROGRESS_OPTION_ID\" }
              }) {
                projectV2Item { id }
              }
            }"

          echo "Moved parent feature #$PARENT_NUMBER to In Progress"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

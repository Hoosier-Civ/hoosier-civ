name: Kanban — All Tasks Done → Close Feature

on:
  issues:
    types: [closed]

jobs:
  check-feature-complete:
    name: Close parent feature if all tasks are done
    runs-on: ubuntu-latest
    permissions:
      issues: write
      repository-projects: write

    steps:
      - name: Find parent issue
        id: parent
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          REPO=${{ github.repository }}
          ORG=$(echo "$REPO" | cut -d/ -f1)
          REPO_NAME=$(echo "$REPO" | cut -d/ -f2)

          PARENT_NUMBER=$(gh api graphql -f query="
            query {
              repository(owner: \"$ORG\", name: \"$REPO_NAME\") {
                issue(number: $ISSUE_NUMBER) {
                  parent { number }
                }
              }
            }" --jq '.data.repository.issue.parent.number // empty')

          if [ -z "$PARENT_NUMBER" ]; then
            echo "Issue #$ISSUE_NUMBER has no parent — skipping"
            exit 0
          fi

          echo "parent_number=$PARENT_NUMBER" >> "$GITHUB_OUTPUT"
          echo "Found parent feature: #$PARENT_NUMBER"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Check if all sibling tasks are closed
        id: check
        if: steps.parent.outputs.parent_number != ''
        run: |
          PARENT_NUMBER=${{ steps.parent.outputs.parent_number }}
          REPO=${{ github.repository }}

          OPEN_COUNT=$(gh api repos/$REPO/issues/$PARENT_NUMBER/sub_issues \
            --jq '[.[] | select(.state == "open")] | length')

          echo "Open tasks remaining: $OPEN_COUNT"
          echo "open_count=$OPEN_COUNT" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Close parent and move to Done
        if: steps.parent.outputs.parent_number != '' && steps.check.outputs.open_count == '0'
        run: |
          PARENT_NUMBER=${{ steps.parent.outputs.parent_number }}
          REPO=${{ github.repository }}
          ORG=$(echo "$REPO" | cut -d/ -f1)
          REPO_NAME=$(echo "$REPO" | cut -d/ -f2)
          PROJECT_NUMBER=1
          DONE_OPTION_ID="f60039e8"

          echo "All tasks complete — closing feature #$PARENT_NUMBER"

          gh issue comment $PARENT_NUMBER \
            --repo $REPO \
            --body "All tasks for this feature have been completed. Closing automatically."

          gh issue close $PARENT_NUMBER --repo $REPO

          # Get the parent's project item ID
          PARENT_ITEM_ID=$(gh api graphql -f query="
            query {
              organization(login: \"$ORG\") {
                projectV2(number: $PROJECT_NUMBER) {
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue { number }
                      }
                    }
                  }
                }
              }
            }" --jq ".data.organization.projectV2.items.nodes[] | select(.content.number == $PARENT_NUMBER) | .id")

          if [ -z "$PARENT_ITEM_ID" ]; then
            echo "Parent #$PARENT_NUMBER not found in project — issue closed but board not updated"
            exit 0
          fi

          # Get the Status field ID
          FIELD_ID=$(gh api graphql -f query="
            query {
              organization(login: \"$ORG\") {
                projectV2(number: $PROJECT_NUMBER) {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField { id name }
                    }
                  }
                }
              }
            }" --jq '.data.organization.projectV2.fields.nodes[] | select(.name == "Status") | .id')

          gh api graphql -f query="
            mutation {
              updateProjectV2ItemFieldValue(input: {
                projectId: \"PVT_kwDODryfUM4BP3nZ\"
                itemId: \"$PARENT_ITEM_ID\"
                fieldId: \"$FIELD_ID\"
                value: { singleSelectOptionId: \"$DONE_OPTION_ID\" }
              }) {
                projectV2Item { id }
              }
            }"

          echo "Feature #$PARENT_NUMBER closed and moved to Done"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
